services:
  shebe-server:
    build:
      context: ..
      dockerfile: services/shebe-server/Dockerfile
    image: shebe:latest
    container_name: shebe-server
    ports:
      - "3000:3000"
    volumes:
      # Persistent index data
      - shebe-data:/data
      # Mount source code for indexing (read-only)
      # Adjust path as needed for your environment
      - /home/orodha/github/openemr/openemr:/code:ro
    environment:
      SHEBE_HOST: 0.0.0.0
      SHEBE_PORT: 3000
      SHEBE_LOG_LEVEL: info
      SHEBE_DATA_DIR: /data
      SHEBE_CHUNK_SIZE: 512
      SHEBE_OVERLAP: 64
      SHEBE_MAX_FILE_SIZE_MB: 10
      RUST_BACKTRACE: 1
    restart: unless-stopped
    healthcheck:
      test:
        - "CMD"
        - "curl"
        - "-f"
        - "http://localhost:3000/health"
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - shebe-network

  shebe-test:
    image: rust:1.83-slim
    container_name: shebe-test
    working_dir: /workspace/services/shebe-server
    volumes:
      # Mount project root (read-write for cargo cache)
      - ../:/workspace:rw
      # Cache cargo registry and git checkouts (speeds up subsequent runs)
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      # Cache build artifacts (speeds up incremental builds)
      - cargo-target:/workspace/services/shebe-server/target
    environment:
      RUST_BACKTRACE: 1
      CARGO_HOME: /usr/local/cargo
    # Default command: run all tests
    command: >
      bash -c "
        apt-get update -qq &&
        apt-get install -y -qq pkg-config libssl-dev curl > /dev/null 2>&1 &&
        cargo test --color=always
      "
    networks:
      - shebe-network
    profiles:
      - test  # Only start with 'docker compose --profile test up'

volumes:
  shebe-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data
  # Cargo cache volumes for faster test runs
  cargo-registry:
    driver: local
  cargo-git:
    driver: local
  cargo-target:
    driver: local

networks:
  shebe-network:
    driver: bridge
