#--------------------------------------------------------------------------------------
# Shebe CI/CD Pipeline
#
# Stages:
#   - prep: Placeholder job for MR pipelines
#   - test: Run tests, fmt check, clippy, coverage
#   - build: Build release binaries (tags only)
#   - package: Create MCPB bundle (tags only)
#   - release: Create GitLab release with artifacts (tags only)
#
# Build Strategy:
#   - build:shebe: Native builds (rust-debian for glibc, rust-alpine for musl)
#   - package:mcpb: Creates MCP Bundle from musl binary
#   - Version extracted from Cargo.toml by each script (no dotenv needed)
#
# Scripts:
#   - scripts/ci-build.sh: Build binaries and create tarballs
#   - scripts/ci-mcpb.sh: Create MCPB bundle from musl binary
#   - scripts/ci-release.sh: Create GitLab release via API
#--------------------------------------------------------------------------------------

stages:
  - prep
  - test
  - build
  - package
  - release

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUST_BACKTRACE: "1"
  SHEBE_SERVICE_DIR: services/shebe-server

# Rules for shebe service changes
.shebe-rules: &shebe-rules
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    changes:
      - services/shebe-server/Cargo.lock
      - services/shebe-server/Cargo.toml
      - services/shebe-server/VERSION
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    changes:
      - services/shebe-server/Cargo.lock
      - services/shebe-server/Cargo.toml
      - services/shebe-server/VERSION

# Rules for building
.build-rules: &build-rules
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  - if: $CI_COMMIT_REF_NAME =~ /^v\d+\.\d+\.\d+/
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    changes:
      - services/shebe-server/Cargo.toml
      - services/shebe-server/Cargo.lock

# Rules for tag-based releases
.release-rules: &release-rules
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  - if: $CI_COMMIT_REF_NAME =~ /^v\d+\.\d+\.\d+/

#--------------------------------------------------------------------------------------
# Test Stage
#--------------------------------------------------------------------------------------

dummy:job:
  stage: prep
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20251111-b3.13-alpine3.22-bc832d850
  script:
    - time # anything that exits with status 0
  interruptible: true
  timeout: 15s
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  before_script: [] # Disable any global before_script
  after_script: [] # Disable any global after_script
  cache: {} # Disable caching
  artifacts:
    reports: {} # Disable artifact generation

# test:shebe:
#   stage: test
#   image: registry.gitlab.com/rhobimd-oss/cicd/lang/rust-alpine:20260119-b1.88-alpine3.22
#   needs: [] # Don't wait for cache job (it's optional)
#   script:
#     - |
#       set -euo pipefail
#       cd ${SHEBE_SERVICE_DIR}

#       echo "=== Toolchain versions ==="
#       rustc --version
#       cargo --version
#       cargo nextest --version
#       cargo tarpaulin --version

#       echo "=== Format check ==="
#       cargo fmt -- --check --verbose

#       echo "=== Build (compile dependencies) ==="
#       cargo check --all-features --workspace

#       echo "=== Clippy (shebe only) ==="
#       cargo clippy --no-deps -- -D warnings

#       echo "=== Tests ==="
#       cargo nextest run --all-features --workspace

#       echo "=== Coverage ==="
#       cargo tarpaulin --skip-clean --all-features --workspace --out Xml --output-dir . --fail-under 60
#   interruptible: true
#   timeout: 30m
#   rules: *shebe-rules
#   coverage: '/^\d+\.\d+% coverage/'
#   artifacts:
#     reports:
#       coverage_report:
#         coverage_format: cobertura
#         path: services/shebe-server/cobertura.xml
#     expire_in: 1 week
#     when: always

#--------------------------------------------------------------------------------------
# Build Stage (Parallel Matrix with Dedicated Native Images)
#
# Uses native images for each target - no cross-compilation needed.
# - rust-debian: glibc/dynamic binaries for standard Linux
# - rust-alpine: musl/static binaries for MCPB bundles, Alpine
#--------------------------------------------------------------------------------------

build:shebe:
  stage: build
  variables:
    CARGO_TERM_COLOR: always
  parallel:
    matrix:
      - BUILD_IMAGE: lang/rust-debian:20260118-b1.88-slim-trixie
        ARTIFACT_SUFFIX: linux-x86_64
        BUILD_MODE: dynamic
      - BUILD_IMAGE: lang/rust-alpine:20260119-b1.88-alpine3.22
        ARTIFACT_SUFFIX: linux-x86_64-musl
        BUILD_MODE: static
  image: registry.gitlab.com/rhobimd-oss/cicd/${BUILD_IMAGE}
  script:
    - ./scripts/ci-build.sh
  interruptible: true
  timeout: 30m
  rules: *build-rules
  artifacts:
    name: "shebe-${ARTIFACT_SUFFIX}"
    paths:
      - releases/
    expire_in: 1 year
    when: on_success

#--------------------------------------------------------------------------------------
# Build MCPB Bundle
#
# Creates MCP Bundle (.mcpb) from the musl static binary for MCP Registry publication.
# Runs after build:shebe completes (needs musl tarball artifact).
#--------------------------------------------------------------------------------------

package:mcpb:
  stage: package
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260117b-b3.13-alpine3.22-b287ff20c
  script:
    - ./scripts/ci-mcpb.sh
  interruptible: true
  timeout: 5m
  rules: *build-rules
  needs:
    - job: build:shebe
      artifacts: true
  artifacts:
    name: "shebe-mcpb"
    paths:
      - releases/*.mcpb
      - releases/*.mcpb.sha256
      - releases/server.json
    expire_in: 1 year
    when: on_success

#--------------------------------------------------------------------------------------
# Release Stage
# Uses CI_JOB_TOKEN for API authentication (no manual token needed)
# Collects artifacts from build:shebe and package:mcpb
#--------------------------------------------------------------------------------------

release:shebe:
  stage: release
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260117b-b3.13-alpine3.22-b287ff20c
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  before_script:
    - git config --global --add safe.directory "${CI_PROJECT_DIR}"
  script:
    - ./scripts/ci-release.sh # Create GitLab release with all artifacts
  rules: *release-rules
  needs:
    - job: build:shebe
      artifacts: true
    - job: package:mcpb
      artifacts: true
  artifacts:
    paths:
      - RELEASE_NOTES.md
      - CHANGELOG.md
    expire_in: 1 year
