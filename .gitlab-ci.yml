#--------------------------------------------------------------------------------------
# Shebe CI/CD Pipeline
#
# Stages:
#   - prep: Placeholder job for MR pipelines
#   - test: Run tests, fmt check, clippy, coverage
#   - build: Build release binaries and upload to package registry (tags only)
#   - release: Create MCPB bundle and GitLab release (tags only)
#
# Build Strategy:
#   - build:linux: Native builds (rust-debian for glibc, rust-alpine for musl)
#   - package:mcpb: Creates MCP Bundle from musl binary
#   - Version extracted from Cargo.toml by rci tool
#
# Tools:
#   - rci v0.1.3-rc6: CI/CD automation tool (replaces bash scripts)
#     Downloaded from: registry.gitlab.com/rhobimd-oss/cicd (package registry)
#     Features: S3-based cache with automatic fingerprint timestamp fix
#--------------------------------------------------------------------------------------

stages:
  - prep
  - test
  - build
  - release
  - publish

default:
  interruptible: true
  image: registry.gitlab.com/rhobimd-oss/cicd/lang/rust-alpine:20260123-b1.88-alpine3.22

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_INCREMENTAL: "0"
  RUST_BACKTRACE: "1"
  RUSTC_WRAPPER: /usr/local/bin/sccache
  SHEBE_SERVICE_DIR: services/shebe-server
  SHEBE_GITHUB_REPO: "rhobimd-oss/shebe"
  # sccache S3-compatible configuration (DigitalOcean Spaces)
  # Credentials set at rhobimd-oss group level
  # SCCACHE_BUCKET: ${SCCACHE_BUCKET}
  # SCCACHE_REGION: ${SCCACHE_REGION}
  # SCCACHE_ENDPOINT: ${SCCACHE_ENDPOINT}
  SCCACHE_S3_USE_SSL: "true"
  SCCACHE_IDLE_TIMEOUT: "0"
  AWS_ACCESS_KEY_ID: ${SCCACHE_AWS_ACCESS_KEY_ID}
  AWS_SECRET_ACCESS_KEY: ${SCCACHE_AWS_SECRET_ACCESS_KEY}
  # RCI vars
  RCI_VERSION: "0.1.3-rc6"
  RCI_CACHE_BUCKET: ${SCCACHE_BUCKET}
  RCI_CACHE_ENDPOINT: ${SCCACHE_ENDPOINT}
  RCI_CACHE_REGION: ${SCCACHE_REGION}

## RULES ======================================================================
# File changes to trigger rules
.shebe-changes: &shebe-changes
  paths:
    - services/shebe-server/Cargo.lock
    - services/shebe-server/Cargo.toml
  compare_to: refs/heads/main

# Rules for shebe service changes
.shebe-rules: &shebe-rules
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    changes: *shebe-changes
  - if: $CI_MERGE_REQUEST_ID
    changes: *shebe-changes

# Rules for tag-based releases
.release-rules: &release-rules
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

.deps-cache: &deps-cache
  key: "shebe-deps"
  paths:
    - .cargo/registry/cache/
    - .cargo/registry/index/
    - .cargo/git/db/

.start-sccache: &start-sccache
  - |
    # Start sccache server in background with debug logging (for S3 init detection)
    SCCACHE_LOG=info SCCACHE_START_SERVER=1 SCCACHE_NO_DAEMON=1 sccache > /tmp/sccache.log 2>&1 &

    # Wait for server to be ready with S3 storage (check log for "server has setup")
    echo "[sccache] Waiting for server to initialize S3..."
    for i in $(seq 1 30); do
      if grep -q "server has setup" /tmp/sccache.log 2>/dev/null; then
        echo "[sccache] Server ready after ${i}s"
        break
      fi
      sleep 2
    done

    # Verify server is running and show stats
    if sccache --show-stats > /dev/null 2>&1; then
      echo "[sccache] Server running:"
      sccache --show-stats | grep -E "^(Cache location|Version)"
    else
      echo "[sccache] WARNING: Server not responding, continuing without cache"
      cat /tmp/sccache.log || true
    fi

# sccache + rci cache restore with --profile release (build jobs)
.start-sccache-and-rci-cache: &start-sccache-and-rci-cache
  - *start-sccache
  - rci cache restore --service-dir services/shebe-server --profile release || true

#--------------------------------------------------------------------------------------
# Test Stage
#======================================================================================

dummy:job:
  stage: prep
  timeout: 60s
  rules:
    - if: $CI_MERGE_REQUEST_ID
  variables:
    GIT_STRATEGY: none
  script:
    - time # anything that exits with status 0
  before_script: [] # Disable any global before_script
  after_script: [] # Disable any global after_script
  cache: {} # Disable caching
  artifacts:
    reports: {} # Disable artifact generation

test:shebe:
  stage: test
  needs: []
  timeout: 20m
  rules: *shebe-rules
  before_script:
    - *start-sccache
    - rci cache restore --service-dir services/shebe-server --profile test || true
  script:
    - |
      set -euo pipefail
      cd ${SHEBE_SERVICE_DIR}

      echo "=== Toolchain versions ==="
      rustc --version
      cargo --version
      cargo nextest --version

      echo "=== Format check ==="
      cargo fmt -- --check --verbose

      echo "=== Build (compile dependencies) ==="
      cargo check --all-features --workspace
      sccache --show-stats 2>/dev/null || true

      echo "=== Clippy (shebe only) ==="
      cargo clippy --no-deps -- -D warnings

      echo "=== Tests ==="
      cargo nextest run --all-features --workspace
      sccache --show-stats 2>/dev/null || true

      echo "=== Test coverage ==="
      cargo tarpaulin --all-features --workspace --out Xml --output-dir . --fail-under 80
      sccache --show-stats 2>/dev/null || true
  after_script:
    - rci cache save --service-dir ${SHEBE_SERVICE_DIR} --profile test || true
    - echo "Final sccache stats:" && sccache --show-stats || true
    - echo "=== sccache server log ===" && tail -50 /tmp/sccache.log 2>/dev/null || true
    - sccache --stop-server || true
  coverage: '/(\d+\.?\d*)% coverage/'
  cache: *deps-cache
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ${SHEBE_SERVICE_DIR}/cobertura.xml

#--------------------------------------------------------------------------------------
# Build Stage
#
# Two parallel build paths:
# 1. Linux builds on GitLab CI (glibc + musl)
# 2. macOS builds on GitHub Actions (triggered via repository_dispatch)
#======================================================================================

build:linux:
  stage: build
  parallel:
    matrix:
      - BUILD_IMAGE: lang/rust-debian:20260123-b1.88-slim-trixie
        ARTIFACT_SUFFIX: linux-x86_64
      - BUILD_IMAGE: lang/rust-alpine:20260123-b1.88-alpine3.22
        ARTIFACT_SUFFIX: linux-x86_64-musl
  timeout: 15m
  rules: *release-rules
  image: registry.gitlab.com/rhobimd-oss/cicd/${BUILD_IMAGE}
  variables:
    GIT_STRATEGY: fetch
    CARGO_TERM_COLOR: always
    RUSTC_WRAPPER: /usr/local/bin/sccache
  before_script: *start-sccache-and-rci-cache
  script:
    - |
      rci build --service-dir services/shebe-server --suffix ${ARTIFACT_SUFFIX} --publish-package-registry
      sccache --show-stats 2>/dev/null || true
      if [ "${ARTIFACT_SUFFIX}" = "linux-x86_64-musl" ]; then
        rci mcpb create --service-dir services/shebe-server --publish-package-registry
      fi
  after_script:
    - rci cache save --service-dir services/shebe-server --profile release || true
    - echo "Final sccache stats:" && sccache --show-stats || true
    - echo "=== sccache server log ===" && tail -50 /tmp/sccache.log 2>/dev/null || true
    - sccache --stop-server || true
  cache: *deps-cache
  artifacts:
    paths:
      - releases/
    expire_in: 1 day

#--------------------------------------------------------------------------------------
# Trigger GitHub Actions for macOS Builds
#
# Triggers GitHub Actions workflow to build macOS binaries (Intel and Apple Silicon).
# Runs in parallel with Linux builds for faster overall pipeline.
#
# CI/CD Variables Required:
#   SHEBE_GITHUB_TOKEN - GitHub Personal Access Token with repo scope (masked, protected)
#======================================================================================

build:macos:
  stage: build
  timeout: 5m
  variables:
    GIT_STRATEGY: fetch
  needs:
    - job: build:linux
  rules: *release-rules
  script:
    - |
      set -euo pipefail

      # Get version from Cargo.toml
      VERSION="v$(grep '^version = ' services/shebe-server/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')"
      echo "Triggering GitHub Actions for macOS build (version: ${VERSION})..."

      # Trigger GitHub Actions workflow via repository_dispatch
      curl -sf -X POST \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${SHEBE_GITHUB_TOKEN}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "https://api.github.com/repos/${SHEBE_GITHUB_REPO}/dispatches" \
        -d "{
          \"event_type\": \"build-macos\",
          \"client_payload\": {
            \"version\": \"${VERSION}\",
            \"ref\": \"${CI_COMMIT_REF_NAME}\",
            \"gitlab_pipeline\": \"${CI_PIPELINE_ID}\"
          }
        }"

      echo "Triggered GitHub Actions for macOS build"
      echo "Check progress at: https://github.com/${SHEBE_GITHUB_REPO}/actions"

#--------------------------------------------------------------------------------------
# Release Stage
#
# Creates releases on both GitLab and GitHub:
#   - GitLab: Primary release with asset links to package registry
#   - GitHub: Draft release with uploaded artifacts (for Zed extension compatibility)
#
# CI/CD Variables Required:
#   SHEBE_GITHUB_TOKEN - GitHub PAT with repo scope (masked, protected)
#
# Note: Artifacts already uploaded to package registry by build jobs.
#======================================================================================

release:shebe:
  stage: release
  needs:
    - job: build:linux
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
      when: manual
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: 0
  before_script:
    - git config --global --add safe.directory "${CI_PROJECT_DIR}"
  script:
    - rci release gitlab --service-dir services/shebe-server --force
    - rci release github --service-dir services/shebe-server --force

#--------------------------------------------------------------------------------------
# Publish to MCP Registry (Manual Trigger)
#
# Publishes Shebe to the official MCP Registry (registry.modelcontextprotocol.io).
# Runs after release:shebe to ensure download URLs in server.json are valid.
#
# CI/CD Variables Required:
#   MCP_PRIVATE_KEY - Private key for DNS-based authentication (masked, protected)
#
# Manual trigger to prevent accidental publication to public registry.
#======================================================================================

publish:mcp-registry:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
      when: manual
  variables:
    GIT_STRATEGY: fetch
  script:
    - rci mcpb publish --from-registry
