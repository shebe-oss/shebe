#--------------------------------------------------------------------------------------
# Shebe CI/CD Pipeline
#
# Stages:
#   - cache: Build Rust dependency cache (only when Cargo.lock changes)
#   - test: Run tests, fmt check, clippy, coverage
#   - build: Build release binaries (tags only, parallel matrix for glibc/musl)
#   - release: Create GitLab release with artifacts (tags only)
#
# Cache Strategy:
#   - cache:rust job runs ONLY when Cargo.toml/Cargo.lock changes (push policy)
#   - All other jobs use pull-only policy to consume the cache
#   - Saves ~3.5min per pipeline by avoiding redundant cache uploads
#
# Scripts:
#   - scripts/ci-build.sh: Build binaries and create tarballs
#   - scripts/ci-release.sh: Create GitLab release via API
#--------------------------------------------------------------------------------------

stages:
  - cache
  - test
  - build
  - release

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUST_BACKTRACE: "1"
  SHEBE_SERVICE_DIR: services/shebe-server

# Cache configuration - all jobs use pull-only
# The cache:rust job is the sole producer (push policy)
.rust_cache:
  cache:
    key:
      files:
        - services/shebe-server/Cargo.lock
    paths:
      - .cargo/
      - services/shebe-server/target/
    policy: pull

# Rules for shebe service changes
.shebe-rules: &shebe-rules
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    changes:
      - services/shebe-server/Cargo.toml
      - services/shebe-server/VERSION
  - if: '$CI_COMMIT_BRANCH == "main"'
    changes:
      - services/shebe-server/Cargo.toml
      - services/shebe-server/VERSION
  - if: '$CI_PIPELINE_SOURCE == "schedule"'
  - if: '$CI_PIPELINE_SOURCE == "api"'

# Rules for cache rebuild (only when Cargo files change)
.cache-rules: &cache-rules
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    changes:
      - services/shebe-server/Cargo.toml
      - services/shebe-server/Cargo.lock
  - if: '$CI_COMMIT_BRANCH == "main"'
    changes:
      - services/shebe-server/Cargo.toml
      - services/shebe-server/Cargo.lock

# Rules for tag-based releases
.release-rules: &release-rules
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

#--------------------------------------------------------------------------------------
# Cache Stage
# Builds and uploads Rust dependency cache ONLY when Cargo.toml/Cargo.lock changes.
# All other jobs use pull-only policy, saving ~3.5min per pipeline.
#--------------------------------------------------------------------------------------

cache:rust:
  stage: cache
  image: registry.gitlab.com/rhobimd-oss/cicd/rust:20251101-b1.88-slim
  script:
    - |
      set -euo pipefail
      cd ${SHEBE_SERVICE_DIR}
      echo "=== Building dependency cache ==="
      cargo check --all-features --workspace
      echo "=== Cache build complete ==="
  cache:
    key:
      files:
        - services/shebe-server/Cargo.lock
    paths:
      - .cargo/
      - services/shebe-server/target/
    policy: push
  interruptible: true
  timeout: 15m
  rules: *cache-rules

#--------------------------------------------------------------------------------------
# Test Stage
#--------------------------------------------------------------------------------------

test:shebe:
  stage: test
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20251111-b3.13-alpine3.22-bc832d850
  script:
    - time # anything that exits with status 0
  interruptible: true
  timeout: 15s
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  before_script: [] # Disable any global before_script
  after_script: [] # Disable any global after_script
  cache: {} # Disable caching
  artifacts:
    reports: {} # Disable artifact generation

test:shebe:
  stage: test
  image: registry.gitlab.com/rhobimd-oss/cicd/rust:20251101-b1.88-slim
  extends: .rust_cache
  needs: []  # Don't wait for cache job (it's optional)
  script:
    - |
      set -euo pipefail
      cd ${SHEBE_SERVICE_DIR}

      echo "=== Toolchain versions ==="
      rustc --version
      cargo --version
      cargo nextest --version
      cargo tarpaulin --version

      echo "=== Format check ==="
      cargo fmt -- --check --verbose

      echo "=== Build (compile dependencies) ==="
      cargo check --all-features --workspace

      echo "=== Clippy (shebe only) ==="
      cargo clippy --no-deps -- -D warnings

      echo "=== Tests ==="
      cargo nextest run --all-features --workspace

      echo "=== Coverage ==="
      cargo tarpaulin --skip-clean --all-features --workspace --out Xml --output-dir . --fail-under 60
  interruptible: true
  timeout: 30m
  rules: *shebe-rules
  coverage: '/^\d+\.\d+% coverage/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: services/shebe-server/cobertura.xml
    expire_in: 1 week
    when: always

#--------------------------------------------------------------------------------------
# Build Stage (Parallel Matrix)
#
# Builds glibc and musl targets in parallel for faster CI.
# Each job produces a tarball uploaded as artifact for the release stage.
#--------------------------------------------------------------------------------------

build:shebe:
  stage: build
  image: registry.gitlab.com/rhobimd-oss/cicd/rust:20260119-b1.88-slim-rc
  extends: .rust_cache
  variables:
    CARGO_TERM_COLOR: always
  parallel:
    matrix:
      - BUILD_TARGET: x86_64-unknown-linux-gnu
        ARTIFACT_SUFFIX: linux-x86_64
      - BUILD_TARGET: x86_64-unknown-linux-musl
        ARTIFACT_SUFFIX: linux-x86_64-musl
  script:
    - ./scripts/ci-build.sh
  interruptible: true
  timeout: 30m
  rules: *release-rules
  artifacts:
    name: "shebe-${CI_COMMIT_TAG}-${ARTIFACT_SUFFIX}"
    paths:
      - releases/
      - build.env
    reports:
      dotenv: build.env
    expire_in: 1 year
    when: on_success

#--------------------------------------------------------------------------------------
# Release Stage
# Uses CI_JOB_TOKEN for API authentication (no manual token needed)
# Collects artifacts from all matrix jobs
#--------------------------------------------------------------------------------------

release:shebe:
  stage: release
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260117b-b3.13-alpine3.22-b287ff20c
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  before_script:
    - git config --global --add safe.directory "${CI_PROJECT_DIR}"
  script:
    - ./scripts/ci-mcpb.sh # Create MCPB bundle from musl binary
    - ./scripts/ci-release.sh # Create GitLab release with all artifacts
  rules: *release-rules
  needs:
    - job: build:shebe
      artifacts: true
  artifacts:
    paths:
      - RELEASE_NOTES.md
      - CHANGELOG.md
    expire_in: 1 year
