#--------------------------------------------------------------------------------------
# Shebe CI/CD Pipeline
#
# Stages:
#   - prep: Placeholder job for MR pipelines
#   - test: Run tests, fmt check, clippy, coverage
#   - build: Build release binaries (tags only)
#   - package: Create MCPB bundle (tags only)
#   - release: Create GitLab release with artifacts (tags only)
#
# Build Strategy:
#   - build:shebe: Native builds (rust-debian for glibc, rust-alpine for musl)
#   - package:mcpb: Creates MCP Bundle from musl binary
#   - Version extracted from Cargo.toml by each script (no dotenv needed)
#
# Scripts:
#   - scripts/ci-build.sh: Build binaries and create tarballs
#   - scripts/ci-mcpb.sh: Create MCPB bundle from musl binary
#   - scripts/ci-release.sh: Create GitLab release via API
#--------------------------------------------------------------------------------------

stages:
  - prep
  - test
  - build
  - release
  - publish

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUST_BACKTRACE: "1"
  SHEBE_SERVICE_DIR: services/shebe-server
  SHEBE_GITHUB_REPO: "rhobimd-oss/shebe"

# File changes to trigger rules
.shebe-changes: &shebe-changes
  paths:
    - services/shebe-server/Cargo.lock
    - services/shebe-server/Cargo.toml
  compare_to: refs/heads/main

# Rules for shebe service changes
.shebe-rules: &shebe-rules
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    changes: *shebe-changes
  - if: $CI_MERGE_REQUEST_ID
    changes: *shebe-changes

# Rules for building
.build-rules: &build-rules
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  - if: $CI_COMMIT_REF_NAME =~ /^v\d+\.\d+\.\d+/
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    changes: *shebe-changes
  - if: $CI_MERGE_REQUEST_ID
    changes: *shebe-changes

# Rules for tag-based releases
.release-rules: &release-rules
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

#--------------------------------------------------------------------------------------
# Test Stage
#--------------------------------------------------------------------------------------

dummy:job:
  stage: prep
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20251111-b3.13-alpine3.22-bc832d850
  variables:
    GIT_STRATEGY: none
  script:
    - time # anything that exits with status 0
  interruptible: true
  timeout: 60s
  rules:
    - if: $CI_MERGE_REQUEST_ID
  before_script: [] # Disable any global before_script
  after_script: [] # Disable any global after_script
  cache: {} # Disable caching
  artifacts:
    reports: {} # Disable artifact generation

# test:shebe:
#   stage: test
#   image: registry.gitlab.com/rhobimd-oss/cicd/lang/rust-alpine:20260119-b1.88-alpine3.22
#   needs: [] # Don't wait for cache job (it's optional)
#   script:
#     - |
#       set -euo pipefail
#       cd ${SHEBE_SERVICE_DIR}

#       echo "=== Toolchain versions ==="
#       rustc --version
#       cargo --version
#       cargo nextest --version
#       cargo tarpaulin --version

#       echo "=== Format check ==="
#       cargo fmt -- --check --verbose

#       echo "=== Build (compile dependencies) ==="
#       cargo check --all-features --workspace

#       echo "=== Clippy (shebe only) ==="
#       cargo clippy --no-deps -- -D warnings

#       echo "=== Tests ==="
#       cargo nextest run --all-features --workspace

#       echo "=== Coverage ==="
#       cargo tarpaulin --skip-clean --all-features --workspace --out Xml --output-dir . --fail-under 60
#   interruptible: true
#   timeout: 30m
#   rules: *shebe-rules
#   coverage: '/^\d+\.\d+% coverage/'
#   artifacts:
#     reports:
#       coverage_report:
#         coverage_format: cobertura
#         path: services/shebe-server/cobertura.xml
#     expire_in: 1 week
#     when: always

#--------------------------------------------------------------------------------------
# Build Stage
#
# Two parallel build paths:
# 1. Linux builds on GitLab CI (glibc + musl)
# 2. macOS builds on GitHub Actions (triggered via repository_dispatch)
#--------------------------------------------------------------------------------------

build:linux:
  stage: build
  parallel:
    matrix:
      - BUILD_IMAGE: lang/rust-debian:20260118-b1.88-slim-trixie
        ARTIFACT_SUFFIX: linux-x86_64
        BUILD_MODE: dynamic
      - BUILD_IMAGE: lang/rust-alpine:20260119-b1.88-alpine3.22
        ARTIFACT_SUFFIX: linux-x86_64-musl
        BUILD_MODE: static
  interruptible: true
  timeout: 30m
  rules: *release-rules
  image: registry.gitlab.com/rhobimd-oss/cicd/${BUILD_IMAGE}
  variables:
    GIT_STRATEGY: fetch
    CARGO_TERM_COLOR: always
    PREVIEW_MODE: true
  script:
    - ./scripts/ci-build.sh --dry-run
  artifacts:
    name: "shebe-${ARTIFACT_SUFFIX}"
    paths:
      - releases/
      - services/shebe-server/Cargo.toml
    expire_in: 1 year
    when: on_success

#--------------------------------------------------------------------------------------
# Trigger GitHub Actions for macOS Builds
#
# Triggers GitHub Actions workflow to build macOS binaries (Intel and Apple Silicon).
# Runs in parallel with Linux builds for faster overall pipeline.
#
# CI/CD Variables Required:
#   SHEBE_GITHUB_TOKEN - GitHub Personal Access Token with repo scope (masked, protected)
#--------------------------------------------------------------------------------------

build:macos:
  stage: build
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260119-b3.13-alpine3.22-b287ff20c-rc
  variables:
    GIT_STRATEGY: fetch
  interruptible: true
  timeout: 5m
  rules: *build-rules
  script:
    - |
      set -euo pipefail

      # Get version from Cargo.toml
      VERSION="v$(grep '^version = ' services/shebe-server/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')"
      echo "Triggering GitHub Actions for macOS build (version: ${VERSION})..."

      # Trigger GitHub Actions workflow via repository_dispatch
      curl -sf -X POST \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${SHEBE_GITHUB_TOKEN}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "https://api.github.com/repos/${SHEBE_GITHUB_REPO}/dispatches" \
        -d "{
          \"event_type\": \"build-macos\",
          \"client_payload\": {
            \"version\": \"${VERSION}\",
            \"ref\": \"${CI_COMMIT_REF_NAME}\",
            \"gitlab_pipeline\": \"${CI_PIPELINE_ID}\"
          }
        }"

      echo "Triggered GitHub Actions for macOS build"
      echo "Check progress at: https://github.com/${SHEBE_GITHUB_REPO}/actions"

#--------------------------------------------------------------------------------------
# Build MCPB Bundle
#
# Creates MCP Bundle (.mcpb) from the musl static binary for MCP Registry publication.
# Runs after build:shebe completes (needs musl tarball artifact).
#--------------------------------------------------------------------------------------

package:mcpb:
  stage: release
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260117b-b3.13-alpine3.22-b287ff20c
  variables:
    GIT_STRATEGY: fetch
    PREVIEW_MODE: true
  script:
    - ./scripts/ci-mcpb.sh --preview
  interruptible: true
  timeout: 5m
  rules: *release-rules
  needs:
    - job: build:linux
      artifacts: true
  artifacts:
    name: "shebe-mcpb"
    paths:
      - releases/*.mcpb
      - releases/*.mcpb.sha256
      - releases/server.json
    expire_in: 1 year
    when: on_success

#--------------------------------------------------------------------------------------
# Release Stage
# Uses CI_JOB_TOKEN for API authentication (no manual token needed)
# Collects artifacts from build:shebe and package:mcpb
#--------------------------------------------------------------------------------------

release:shebe:
  stage: release
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260117b-b3.13-alpine3.22-b287ff20c
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: 0
    PREVIEW_MODE: true
  before_script:
    - git config --global --add safe.directory "${CI_PROJECT_DIR}"
  script:
    - ./scripts/ci-release.sh --preview # Create GitLab release with all artifacts
  rules: *release-rules
  needs:
    - job: build:linux
      artifacts: true
    - job: package:mcpb
      artifacts: true
  artifacts:
    paths:
      - RELEASE_NOTES.md
      - CHANGELOG.md
    expire_in: 1 year

#--------------------------------------------------------------------------------------
# GitHub Release (for Zed Extension)
#
# Creates a draft GitHub release and uploads Linux artifacts.
# Required because Zed's extension API only reads from GitHub releases.
# macOS builds are triggered separately in build:macos job.
#
# CI/CD Variables Required:
#   GITHUB_PAT - GitHub Personal Access Token with repo scope (masked, protected)
#
# Script: scripts/ci-github-release.sh
#--------------------------------------------------------------------------------------

# release:github:
#   stage: release
#   image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260119-b3.13-alpine3.22-b287ff20c-rc
#   script:
#     - ./scripts/ci-github-release.sh --no-trigger
#   artifacts:
#     reports:
#       dotenv: github_release.env
#   rules: *release-rules
#   needs:
#     - job: build:linux
#       artifacts: true

#--------------------------------------------------------------------------------------
# Publish to MCP Registry (Manual Trigger)
#
# Publishes Shebe to the official MCP Registry (registry.modelcontextprotocol.io).
# Requires MCP_PRIVATE_KEY CI/CD variable for DNS-based authentication.
# Manual trigger to prevent accidental publication.
#--------------------------------------------------------------------------------------

# publish:mcp-registry:
#   stage: publish
#   image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260119-b3.13-alpine3.22-b287ff20c-rc
#   variables:
#     MCP_DOMAIN: "oss.rhobimd.health"
#   script:
#     - ./scripts/ci-mcpb-publish.sh
#   rules: *release-rules
#   needs:
#     - job: package:mcpb
#       artifacts: true
#     - job: release:shebe
#       artifacts: false
